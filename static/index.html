<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hide and Seek JS Client</title>
    <!-- PWA Manifest Verlinkung - Pfad relativ zum Root der Webseite -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme Color für Browser-UI -->
    <meta name="theme-color" content="#007bff">

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 10px; background-color: #f4f4f8; color: #333; font-size: 16px; line-height: 1.5; }
        .container { background-color: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h1, h2, h3 { color: #333; margin-top: 0; }
        h1 { font-size: 1.8em; } h2 { font-size: 1.5em; } h3 { font-size: 1.2em; }
        .info { margin-bottom: 8px; padding: 8px 0; border-bottom: 1px solid #eee; }
        .info:last-child { border-bottom: none; }
        .info strong { color: #555; }
        .player-list { list-style: none; padding-left: 0; }
        .player-list li { padding: 8px; border-bottom: 1px solid #f0f0f0; }
        .player-list li:last-child { border-bottom: none; }
        .error { color: #d9534f; background-color: #f2dede; border: 1px solid #ebccd1; padding: 10px; border-radius: 4px; margin-top:10px;}
        .success { color: #5cb85c; background-color: #dff0d8; border: 1px solid #d6e9c6; padding: 10px; border-radius: 4px; margin-top:10px;}
        .highlight { background-color: #e6f7ff; font-weight: bold; }
        button, input[type="submit"] { display: block; width: 100%; padding: 12px 15px; margin: 10px 0; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.2s ease; }
        button:hover, input[type="submit"]:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button.ready { background-color: #28a745; } button.ready:hover { background-color: #1e7e34; }
        button.unready { background-color: #ffc107; color: #333; } button.unready:hover { background-color: #d39e00; }
        button.action-btn { background-color: #17a2b8; margin-top: 5px; font-size: 0.9em; padding: 8px 10px;}
        button.action-btn:hover { background-color: #117a8b; }
        input[type="text"], select { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1em;}
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555;}
        #mapLink a { color: #007bff; text-decoration: none; font-weight: normal; }
        .countdown { font-size: 1.8em; font-weight: bold; color: #dc3545; text-align: center; padding:10px; background-color: #fff3cd; border-radius: 5px; margin: 10px 0;}
        .status-active { color: green; font-weight: bold; } .status-caught { color: orange; font-weight: bold; } .status-failed, .status-failed-loc { color: red; font-weight: bold; } 
        .leaderboard { width: 100%; border-collapse: collapse; margin-top:10px; }
        .leaderboard th, .leaderboard td { text-align: left; padding: 10px; border-bottom: 1px solid #ddd;}
        .leaderboard th { background-color: #f8f9fa; color: #333; }
        .section { display: none; } .visible { display: block !important; }
        .centered-text { text-align: center; }
        .dimmed { color: #777; }
        #messages-section p { margin: 5px 0;}
    </style>
</head>
<body>
    <div id="app-container">
        <div id="join-section" class="container section">
            <h1>Spiel beitreten</h1>
            <p class="info">Server Verbindung: <span id="join-socket-status-display" class="dimmed">Prüfe...</span></p>
            <p class="info">Spiel Status: <span id="join-game-status-display" class="dimmed">Verbinde...</span></p>
            <form id="join-form">
                <label for="nickname">Nickname:</label>
                <input type="text" id="nickname" name="nickname" required>
                <label for="role-choice">Gewünschte Rolle:</label>
                <select id="role-choice" name="role">
                    <option value="hider">Hider</option>
                    <option value="seeker">Seeker</option>
                </select>
                <button type="submit" id="join-game-button">Spiel suchen & Registrieren</button>
            </form>
            <p id="join-error-message" class="error" style="display:none;"></p>
        </div>

        <div id="pending-lobby-join-section" class="container section">
            <h2>Registrierung zum Server erfolgreich!</h2>
            <p>Du bist beim Spielserver als <strong id="pending-lobby-player-name"></strong> (<span id="pending-lobby-player-role-wish"></span>) angemeldet.</p>
            <p>Server Verbindung: <span id="pending-lobby-socket-status-display" class="dimmed">Warte auf Server...</span></p>
            <p>Spiel Status: <span id="pending-lobby-game-status-display" class="dimmed">Warte auf Server...</span></p>
            <p>Klicke unten, um der aktiven Spiel-Lobby beizutreten und dich für den Spielstart bereitzumachen.</p>
            <button id="confirm-lobby-join-button">Der Lobby beitreten</button>
        </div>

        <div id="player-section" class="container section">
            <h1>Hide and Seek</h1>
            <p class="info"><strong>Name:</strong> <span id="player-name">N/A</span> (ID: <span id="player-id" class="dimmed">N/A</span>)</p>
            <p class="info"><strong>Aktuelle Rolle:</strong> <span id="player-role">N/A</span></p>
            <p class="info"><strong>Dein Status:</strong> <span id="player-status-ingame">N/A</span></p>
            <p class="info"><strong>Spielphase:</strong> <span id="game-status-display" class="dimmed">Lade...</span></p>
            <div id="hider-wait-countdown-container" style="display:none;">
                <p class="countdown">Hider Vorbereitungszeit: <span id="hider-wait-time-left">0</span> Sek</p>
            </div>
            <div id="game-time-left-container" style="display:none;">
                <p class="info centered-text"><strong>Verbleibende Spielzeit:</strong> <span id="game-time-left" class="countdown" style="font-size:1.2em; color:#007bff;">0</span></p>
            </div>
            <p class="info"><strong>Deine Position:</strong> <span id="player-location" class="dimmed">Warte auf GPS...</span>
                <span id="mapLink" style="display:none;"><a href="#" target="_blank">(Auf Karte zeigen)</a></span>
            </p>
            <p class="info dimmed" style="font-size:0.8em">Standort-Genauigkeit: <span id="player-accuracy">N/A</span> m</p>
            <p id="hider-warning-text" class="error" style="display:none; font-weight:bold; text-align:center;">
                ACHTUNG HIDER! Dein Standort wird bald an die Seeker gesendet. Stelle sicher, dass die App deinen aktuellen Standort übermittelt!
            </p>
        </div>

        <div id="messages-section" class="container section" style="padding:0;">
            <p id="game-message" class="success" style="display:none;"></p>
            <p id="error-message" class="error" style="display:none;"></p>
            <p id="location-error-message" class="error" style="display:none;"></p>
        </div>

        <div id="lobby-section" class="container section">
            <h2>Aktive Spiel-Lobby</h2>
            <p>Spiel startet, sobald alle beigetretenen Spieler bereit sind.</p>
            <ul id="lobby-player-list" class="player-list"></ul>
            <form id="ready-form">
                <button type="submit" id="ready-button">Bereit zum Spielstart!</button>
            </form>
        </div>

        <div id="hider-section" class="container section">
            <h2>Hider Informationen</h2>
            <div id="hider-task-info" class="task-info" style="display:none;">
                <h3>Aktuelle Aufgabe</h3>
                <p><strong>Beschreibung:</strong> <span id="task-description"></span></p>
                <p><strong>Punkte:</strong> <span id="task-points"></span></p>
                <p><strong>Verbleibende Zeit:</strong> <span id="task-time-left" class="countdown" style="font-size:1em; color:#dc3545;"></span> Sek</p>
                <form id="complete-task-form"><button type="submit" class="action-btn">Aufgabe als erledigt markieren!</button></form>
            </div>
            <p id="hider-no-task-message" style="display:none;" class="dimmed">Warte auf eine neue Aufgabe vom Server...</p>
            <p id="hider-caught-message" class="error" style="display:none;">Du wurdest gefangen! Du bist jetzt ein Seeker.</p>
            <p id="hider-failed-task-message" class="error" style="display:none;">Du hast deine letzte Aufgabe nicht rechtzeitig geschafft und bist ausgeschieden.</p>
            <p id="hider-failed-location-message" class="error" style="display:none;">Standort nicht rechtzeitig aktualisiert - disqualifiziert!</p>
            <div id="hider-leaderboard-container" style="display:none;">
                <h3>Hider Leaderboard</h3>
                <table id="hider-leaderboard" class="leaderboard">
                    <thead><tr><th>Name</th><th>Punkte</th><th>Status</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="seeker-section" class="container section">
            <h2>Seeker Informationen</h2>
            <div id="seeker-hider-locations-container">
                <h3>Sichtbare Hider</h3>
                <ul id="seeker-hider-list" class="player-list"></ul>
                <p id="seeker-no-hiders-message" style="display:none;" class="dimmed centered-text">Momentan keine Hider sichtbar oder alle Hider wurden bereits gefangen.</p>
            </div>
            <div id="seeker-powerups-container" style="margin-top: 15px;">
                <h3>Verfügbare Power-Ups</h3>
                <div id="seeker-powerups-list"></div>
                <p id="seeker-no-powerups-message" style="display:none;" class="dimmed centered-text">Keine Power-Ups verfügbar oder alle sind im Cooldown.</p>
            </div>
        </div>

        <div id="all-players-section" class="container section">
            <h3>Alle Spieler im Spiel</h3>
            <ul id="all-players-list" class="player-list"></ul>
        </div>

        <div id="game-over-section" class="container section">
            <h2>Spiel Vorbei!</h2>
            <p id="game-over-message" style="font-size: 1.2em; font-weight: bold; text-align: center;"></p>
            <div id="game-over-leaderboard-container" style="display:none;">
                <h3>Finale Hider Rangliste</h3>
                <table id="game-over-leaderboard" class="leaderboard">
                    <thead><tr><th>Name</th><th>Punkte</th><th>Status</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <button onclick="handleGameOverReset()">Zurück zur Lobby (Neues Spiel)</button>
        </div>
    </div>

    <script>
        // Service Worker Registrierung
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js', { scope: '/' }) 
                    .then(registration => {
                        console.log('ServiceWorker Registrierung erfolgreich, Scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('ServiceWorker Registrierung fehlgeschlagen:', error);
                    });
            });
        }

        let currentPlayerData = {};
        const GAME_STATE_LOBBY = "lobby";
        const GAME_STATE_HIDER_WAIT = "hider_wait";
        const GAME_STATE_RUNNING = "running";
        const GAME_STATE_HIDER_WINS = "hider_wins";
        const GAME_STATE_SEEKER_WINS = "seeker_wins";

        const LOCATION_UPDATE_INTERVAL_MS = 10000;
        let locationWatchId = null;
        let lastLocationSentTime = 0;

        function $(selector) { return document.querySelector(selector); }
        function show(id) { const el = $(`#${id}`); if (el) el.classList.add('visible'); }
        function hide(id) { const el = $(`#${id}`); if (el) el.classList.remove('visible'); }
        function setText(id, textContent) { const el = $(`#${id}`); if (el) el.textContent = textContent || ''; }
        function setHtml(id, htmlContent) { const el = $(`#${id}`); if (el) el.innerHTML = htmlContent || ''; }
        function toggleDisplay(id, showFlag, displayType = 'block') {
            const el = $(`#${id}`);
            if (el) el.style.display = showFlag ? displayType : 'none';
        }

        function updateUI(data) {
            console.log("UI Update mit Daten:", JSON.parse(JSON.stringify(data)));
            currentPlayerData = data; 

            document.querySelectorAll('#app-container > .container.section').forEach(el => el.classList.remove('visible'));

            let messagesWereShown = false;
            if (data.game_message) {
                setText('game-message', data.game_message); toggleDisplay('game-message', true);
                messagesWereShown = true; setTimeout(() => { toggleDisplay('game-message', false); if(currentPlayerData) currentPlayerData.game_message = null; }, 5000);
            } else { toggleDisplay('game-message', false); }

            if (data.error_message) {
                setText('error-message', data.error_message); toggleDisplay('error-message', true);
                messagesWereShown = true; setTimeout(() => { toggleDisplay('error-message', false); if(currentPlayerData) currentPlayerData.error_message = null; }, 8000);
            } else { toggleDisplay('error-message', false); }
            
            const locationErrorEl = $('#location-error-message');
            if (locationErrorEl.textContent && locationErrorEl.style.display !== 'none') messagesWereShown = true;
            
            if (data.join_error && !data.player_id) { 
                setText('join-error-message', data.join_error); toggleDisplay('join-error-message', true);
            } else { toggleDisplay('join-error-message', false); }

            if(messagesWereShown) show('messages-section'); else hide('messages-section');

            const serverGameStatus = data.game_state?.status;
            const serverGameStatusDisplay = data.game_state?.status_display || "Lade...";
            const isSocketConnected = data.is_socket_connected_to_server === true;

            const locationDisplay = $('#player-location');
            if (locationDisplay.textContent.includes('Warte auf GPS...') || locationDisplay.textContent.includes('(Server)')) {
                if (data.location && data.location.length >= 2) { 
                    locationDisplay.textContent = `Lat: ${parseFloat(data.location[0]).toFixed(5)}, Lon: ${parseFloat(data.location[1]).toFixed(5)} (Server)`;
                    $('#mapLink a').href = `https://www.google.com/maps?q=${data.location[0]},${data.location[1]}`;
                    toggleDisplay('mapLink', true, 'inline');
                    if (data.location.length > 2 && data.location[2] !== null) {
                        setText('player-accuracy', parseFloat(data.location[2]).toFixed(1));
                    } else { setText('player-accuracy', 'N/A'); }
                } else { 
                    locationDisplay.textContent = 'Standort wird vom Browser ermittelt...';
                    toggleDisplay('mapLink', false); setText('player-accuracy', 'N/A');
                }
            }
            
            toggleDisplay('hider-warning-text', data.role === 'hider' && data.hider_location_update_imminent === true);

            if (!data.player_id && !data.player_name_pending) { 
                show('join-section');
                setText('join-socket-status-display', isSocketConnected ? "Verbunden" : "Nicht verbunden");
                $('#join-socket-status-display').className = isSocketConnected ? 'status-active' : 'error';
                setText('join-game-status-display', serverGameStatusDisplay);
                const nicknameInput = $('#nickname');
                if (!nicknameInput.value.trim() || nicknameInput.value.startsWith("Spieler")) {
                     nicknameInput.value = data.session_nickname || data.prefill_nickname || `Spieler${Math.floor(Math.random()*900)+100}`;
                }
                if (data.session_role_choice) $('#role-choice').value = data.session_role_choice;
                $('#join-game-button').disabled = !isSocketConnected;
            } else { 
                show('player-section'); 
                setText('player-name', data.player_name || data.player_name_pending || "Unbekannt");
                setText('player-id', data.player_id || "Warte auf Server...");
                setText('player-role', data.role || data.role_pending || "Unbekannt");
                
                let playerStatusText = 'Unbekannt';
                if (data.player_status === 'active') playerStatusText = 'Aktiv im Spiel';
                else if (data.player_status === 'caught') playerStatusText = 'Gefangen (jetzt Seeker)';
                else if (data.player_status === 'failed_task') playerStatusText = 'Ausgeschieden (Aufgabe verfehlt)';
                else if (data.player_status === 'failed_loc_update') playerStatusText = 'Ausgeschieden (Standort nicht aktualisiert)';
                setText('player-status-ingame', playerStatusText);
                setText('game-status-display', serverGameStatusDisplay);

                updateHiderStatusMessages(data.player_status);

                if (data.player_id && !data.confirmed_for_lobby && serverGameStatus === GAME_STATE_LOBBY) {
                    show('pending-lobby-join-section');
                    setText('pending-lobby-player-name', data.player_name || "Dein Name");
                    setText('pending-lobby-player-role-wish', data.role || "Deine Rolle");
                    setText('pending-lobby-socket-status-display', isSocketConnected ? "Verbunden" : "Nicht verbunden");
                    $('#pending-lobby-socket-status-display').className = isSocketConnected ? 'status-active' : 'error';
                    setText('pending-lobby-game-status-display', serverGameStatusDisplay);
                    $('#confirm-lobby-join-button').disabled = !isSocketConnected;
                } else if (data.player_id && data.confirmed_for_lobby && serverGameStatus === GAME_STATE_LOBBY) {
                    show('lobby-section');
                    updateLobbyPlayerList(data.lobby_players, String(data.player_id));
                    const readyButton = $('#ready-button');
                    readyButton.textContent = data.player_is_ready ? 'Status: Bereit (Klick zum Ändern)' : 'Klicken: Ich bin bereit!';
                    readyButton.className = data.player_is_ready ? 'unready' : 'ready';
                    readyButton.disabled = !isSocketConnected;
                } else if (serverGameStatus === GAME_STATE_HIDER_WAIT) {
                    toggleDisplay('hider-wait-countdown-container', true);
                    setText('hider-wait-time-left', data.game_state?.hider_wait_time_left || '0');
                    toggleDisplay('game-time-left-container', false);
                    if (data.role === 'hider') show('hider-section'); else if (data.role === 'seeker') show('seeker-section');
                    show('all-players-section'); updateAllPlayersList(data.all_players_status, String(data.player_id));
                } else if (serverGameStatus === GAME_STATE_RUNNING) {
                    toggleDisplay('hider-wait-countdown-container', false);
                    toggleDisplay('game-time-left-container', true);
                    const timeLeft = data.game_state?.game_time_left || 0;
                    setText('game-time-left', `${Math.floor(timeLeft / 60)} Min ${timeLeft % 60} Sek`);

                    if (data.role === 'hider') {
                        show('hider-section');
                        updateHiderTask(data.current_task);
                        toggleDisplay('hider-leaderboard-container', data.hider_leaderboard && data.hider_leaderboard.length > 0);
                        updateHiderLeaderboard(data.hider_leaderboard, String(data.player_id), 'hider-leaderboard');
                    } else if (data.role === 'seeker') {
                        show('seeker-section');
                        updateSeekerHiderList(data.hider_locations);
                        updateSeekerPowerups(data.power_ups_available);
                    }
                    show('all-players-section'); updateAllPlayersList(data.all_players_status, String(data.player_id));
                } else if (serverGameStatus === GAME_STATE_HIDER_WINS || serverGameStatus === GAME_STATE_SEEKER_WINS) {
                    show('game-over-section');
                    setText('game-over-message', data.game_state?.game_over_message || "Das Spiel ist vorbei.");
                    toggleDisplay('game-over-leaderboard-container', data.hider_leaderboard && data.hider_leaderboard.length > 0);
                    updateHiderLeaderboard(data.hider_leaderboard, String(data.player_id), 'game-over-leaderboard');
                } else if (data.player_name_pending && !data.player_id && (serverGameStatus === 'disconnected' || !serverGameStatus) ) {
                    setText('game-status-display', data.game_state?.status_display || 'Warte auf Bestätigung vom Server...');
                }
            }
            if (currentPlayerData && currentPlayerData.player_id &&
                (serverGameStatus === GAME_STATE_LOBBY || serverGameStatus === GAME_STATE_HIDER_WAIT || serverGameStatus === GAME_STATE_RUNNING)) {
                startLocationUpdates();
            } else {
                stopLocationUpdates();
            }
        }

        function updateLobbyPlayerList(lobbyPlayers, currentPlayerIdStr) {
            const ul = $('#lobby-player-list'); setHtml('lobby-player-list', '');
            if (lobbyPlayers && Object.keys(lobbyPlayers).length > 0) {
                for (const pid in lobbyPlayers) {
                    const p = lobbyPlayers[pid]; const li = document.createElement('li');
                    let roleDisplay = p.role === 'hider' ? 'Hider' : (p.role === 'seeker' ? 'Seeker' : 'Unbekannt');
                    let readyDisplay = p.is_ready ? '<span class="status-active">Bereit</span>' : '<span class="dimmed">Wartet...</span>';
                    li.innerHTML = `${p.name} (Rolle: ${roleDisplay}) - Status: ${readyDisplay}`;
                    if (pid === currentPlayerIdStr) li.classList.add('highlight');
                    ul.appendChild(li);
                }
            } else { ul.innerHTML = '<li class="dimmed">Warte auf weitere Spieler...</li>'; }
        }
        function updateAllPlayersList(allPlayers, currentPlayerIdStr) {
            const el = $('#all-players-list'); setHtml('all-players-list', '');
            if (allPlayers && Object.keys(allPlayers).length > 0) {
                for (const pid in allPlayers) {
                    const p = allPlayers[pid]; const li = document.createElement('li');
                    let statusDisplay;
                    if (p.status === 'active') statusDisplay = '<span class="status-active">Aktiv</span>';
                    else if (p.status === 'caught') statusDisplay = '<span class="status-caught">Gefangen</span>';
                    else if (p.status === 'failed_task') statusDisplay = '<span class="status-failed">Aufgabe verfehlt</span>';
                    else if (p.status === 'failed_loc_update') statusDisplay = '<span class="status-failed-loc">Kein Standort</span>';
                    else statusDisplay = `<span class="dimmed">${p.status || 'Unbekannt'}</span>`;
                    li.innerHTML = `${p.name} (Rolle: ${p.role || 'N/A'}) - ${statusDisplay}`;
                    if (pid === currentPlayerIdStr) li.classList.add('highlight');
                    el.appendChild(li);
                }
            } else { el.innerHTML = '<li class="dimmed">Keine Spielerinformationen.</li>'; }
        }
        function updateHiderTask(task) {
            const socketConnected = currentPlayerData && currentPlayerData.is_socket_connected_to_server === true;
            if (task && task.description) {
                toggleDisplay('hider-task-info', true); toggleDisplay('hider-no-task-message', false);
                setText('task-description', task.description); setText('task-points', task.points);
                setText('task-time-left', task.time_left_seconds);
                $('#complete-task-form button').disabled = task.time_left_seconds <= 0 || !socketConnected;
            } else {
                toggleDisplay('hider-task-info', false); toggleDisplay('hider-no-task-message', true);
            }
        }
        function updateHiderStatusMessages(playerStatus) {
            toggleDisplay('hider-caught-message', playerStatus === 'caught');
            toggleDisplay('hider-failed-task-message', playerStatus === 'failed_task');
            toggleDisplay('hider-failed-location-message', playerStatus === 'failed_loc_update');
        }
        function updateHiderLeaderboard(leaderboardData, currentPlayerIdStr, tableId = 'hider-leaderboard') {
            const table = $(`#${tableId}`); const tbody = table ? table.querySelector('tbody') : null;
            if (!tbody) return; tbody.innerHTML = '';
            if (leaderboardData && leaderboardData.length > 0) {
                toggleDisplay(table.id, true);
                leaderboardData.forEach(entry => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = entry.name; row.insertCell().textContent = entry.points;
                    const statusCell = row.insertCell(); let statusDisplay;
                    if (entry.status === 'active') statusDisplay = '<span class="status-active">Aktiv</span>';
                    else if (entry.status === 'caught') statusDisplay = '<span class="status-caught">Gefangen</span>';
                    else if (entry.status === 'failed_task') statusDisplay = '<span class="status-failed">Aufgabe verfehlt</span>';
                    else if (entry.status === 'failed_loc_update') statusDisplay = '<span class="status-failed-loc">Kein Standort</span>';
                    else statusDisplay = `<span class="dimmed">${entry.status || 'Unbekannt'}</span>`;
                    statusCell.innerHTML = statusDisplay;
                    if (String(entry.id) === currentPlayerIdStr) row.classList.add('highlight');
                });
            } else {
                 const colspan = (table.querySelector('thead tr th') || []).length || 3;
                 tbody.innerHTML = `<tr><td colspan="${colspan}" class="dimmed centered-text">Noch keine Punkte.</td></tr>`;
                 toggleDisplay(table.id, true);
            }
        }
        function updateSeekerHiderList(hiderLocations) {
            const ul = $('#seeker-hider-list'); const noHidersMsg = $('#seeker-no-hiders-message');
            ul.innerHTML = ''; const socketConnected = currentPlayerData && currentPlayerData.is_socket_connected_to_server === true;
            if (hiderLocations && Object.keys(hiderLocations).length > 0) {
                toggleDisplay(noHidersMsg.id, false);
                for (const hiderId in hiderLocations) {
                    const hider = hiderLocations[hiderId]; const li = document.createElement('li');
                    li.innerHTML = `<strong>${hider.name}</strong> (Gesehen: ${hider.timestamp || 'N/A'})
                        <br><span class="dimmed">Lat: ${parseFloat(hider.lat).toFixed(4)}, Lon: ${parseFloat(hider.lon).toFixed(4)}</span>
                        <a href="https://www.google.com/maps?q=${hider.lat},${hider.lon}" target="_blank" style="margin-left: 5px;">Karte</a>
                        <button class="catch-hider-btn action-btn" data-hider-id="${hiderId}" ${!socketConnected ? 'disabled' : ''}>Fangen!</button>`;
                    ul.appendChild(li);
                }
                document.querySelectorAll('.catch-hider-btn').forEach(button => {
                    button.onclick = async function() { await sendClientAction('/catch_hider', { hider_id_to_catch: this.dataset.hiderId }); };
                });
            } else { toggleDisplay(noHidersMsg.id, true); }
        }
        function updateSeekerPowerups(powerups) {
            const listDiv = $('#seeker-powerups-list'); const noPowerupsMsg = $('#seeker-no-powerups-message');
            listDiv.innerHTML = ''; const socketConnected = currentPlayerData && currentPlayerData.is_socket_connected_to_server === true;
            if (powerups && powerups.length > 0) {
                toggleDisplay(noPowerupsMsg.id, false);
                powerups.forEach(pu => {
                    const button = document.createElement('button');
                    button.textContent = `${pu.name} (Einsetzen)`; button.dataset.powerupId = pu.id;
                    button.className = 'use-powerup-btn action-btn'; button.disabled = !socketConnected;
                    listDiv.appendChild(button);
                });
                document.querySelectorAll('.use-powerup-btn').forEach(button => {
                    button.onclick = async function() { await sendClientAction('/use_powerup', { powerup_id: this.dataset.powerupId }); };
                });
            } else { toggleDisplay(noPowerupsMsg.id, true); }
        }

        async function sendClientAction(endpoint, bodyPayload = null) {
            try {
                const options = { method: 'POST', headers: {'Content-Type': 'application/json'}};
                if (bodyPayload) options.body = JSON.stringify(bodyPayload);
                const response = await fetch(endpoint, options);
                const responseData = await response.json();
                updateUI(responseData); 
            } catch (error) {
                console.error(`Netzwerk-/Parse-Fehler bei Aktion ${endpoint}:`, error);
                const errorData = JSON.parse(JSON.stringify(currentPlayerData || {})); 
                errorData.error_message = `Netzwerkfehler: Aktion '${endpoint.substring(1)}' fehlgeschlagen.`;
                if (!errorData.game_state) errorData.game_state = {}; 
                errorData.is_socket_connected_to_server = false; 
                updateUI(errorData);
            }
        }

        function handleLocationSuccess(position) {
            const lat = position.coords.latitude; const lon = position.coords.longitude; const accuracy = position.coords.accuracy;
            console.log(`Browser Location: Lat ${lat.toFixed(5)}, Lon ${lon.toFixed(5)}, Acc ${accuracy.toFixed(1)}`);
            setText('player-location', `Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)} (Browser)`);
            setText('player-accuracy', accuracy.toFixed(1));
            $('#mapLink a').href = `https://www.google.com/maps?q=${lat},${lon}`;
            toggleDisplay('mapLink', true, 'inline'); toggleDisplay('location-error-message', false);
            const now = Date.now();
            if (currentPlayerData && currentPlayerData.player_id && (now - lastLocationSentTime > (LOCATION_UPDATE_INTERVAL_MS / 2) || lastLocationSentTime === 0 )) {
                sendLocationToClientBackend(lat, lon, accuracy);
                lastLocationSentTime = now;
            }
        }
        function handleLocationError(error) {
            let message = "Unbekannter Standortfehler";
            switch(error.code) {
                case error.PERMISSION_DENIED: message = "Zugriff auf Standort blockiert."; break;
                case error.POSITION_UNAVAILABLE: message = "Standortinformationen nicht verfügbar."; break;
                case error.TIMEOUT: message = "Timeout bei der Standortabfrage."; break;
            }
            console.error("Browser Location Error:", message, error);
            setText('player-location', 'Standortfehler vom Browser.'); setText('player-accuracy', 'N/A');
            toggleDisplay('mapLink', false);
            setText('location-error-message', message); toggleDisplay('location-error-message', true);
            show('messages-section');
        }
        async function sendLocationToClientBackend(lat, lon, accuracy) {
            try {
                const response = await fetch('/update_location_from_browser', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ lat: lat, lon: lon, accuracy: accuracy })
                });
                const result = await response.json();
                if (response.ok && result.success) console.log("Standort an Client-Backend gesendet.");
                else console.warn("Fehler Senden Standort an Client-Backend:", result.message);
            } catch (error) { console.error("Netzwerkfehler Senden Standort an Client-Backend:", error); }
        }
        function startLocationUpdates() {
            if (navigator.geolocation) {
                if (locationWatchId === null) { 
                    console.log("Starte Browser-Standort-Updates...");
                    setText('player-location', 'Ermittle Standort (Browser)...'); 
                    locationWatchId = navigator.geolocation.watchPosition(handleLocationSuccess, handleLocationError,
                        { enableHighAccuracy: true, timeout: LOCATION_UPDATE_INTERVAL_MS * 2, maximumAge: 0 });
                }
            } else { setText('player-location', 'Browser-Geolocation nicht unterstützt.'); }
        }
        function stopLocationUpdates() {
            if (navigator.geolocation && locationWatchId !== null) {
                console.log("Stoppe Browser-Standort-Updates.");
                navigator.geolocation.clearWatch(locationWatchId); locationWatchId = null;
            }
        }

        $('#join-form').addEventListener('submit', async (event) => {
            event.preventDefault(); const nickname = $('#nickname').value; const role = $('#role-choice').value;
            $('#join-game-button').disabled = true; 
            await sendClientAction('/join_game', { nickname: nickname, role: role });
        });
        $('#confirm-lobby-join-button')?.addEventListener('click', async () => { 
             $('#confirm-lobby-join-button').disabled = true; await sendClientAction('/confirm_lobby_join');
        });
        $('#ready-form').addEventListener('submit', async (event) => {
            event.preventDefault(); const newReadyStatus = !(currentPlayerData.player_is_ready || false);
            $('#ready-button').disabled = true;
            await sendClientAction('/set_ready', { ready_status: newReadyStatus });
        });
        $('#complete-task-form button')?.addEventListener('click', async (event) => {
            event.preventDefault(); $('#complete-task-form button').disabled = true;
            await sendClientAction('/complete_task');
        });
        
        async function handleGameOverReset() {
            const gameOverButton = document.querySelector('#game-over-section button');
            if (gameOverButton) gameOverButton.disabled = true;

            try {
                const response = await fetch('/request_reset_game_on_server', { method: 'POST' });
                const responseData = await response.json(); 
                updateUI(responseData); 
            } catch (error) {
                console.error('Fehler beim Anfordern des Spiel-Resets via /request_reset_game_on_server:', error);
                const errorState = JSON.parse(JSON.stringify(currentPlayerData || {}));
                if (!errorState.game_state) errorState.game_state = {};
                errorState.game_state.status_display = "Fehler beim Zurücksetzen des Spiels.";
                errorState.error_message = "Lokaler Client-Server nicht erreichbar für Reset-Anfrage.";
                errorState.is_socket_connected_to_server = false; 
                updateUI(errorState);
            } finally {
                if (gameOverButton) gameOverButton.disabled = false; 
            }
        }

        async function fetchStatusAndUpdateUI() {
            try {
                const response = await fetch('/status');
                if (!response.ok) { 
                    const errorData = JSON.parse(JSON.stringify(currentPlayerData || {}));
                    if (!errorData.game_state) errorData.game_state = {};
                    errorData.game_state.status_display = `Fehler Client-Server (${response.status}).`;
                    errorData.error_message = "Verbindung zum lokalen Client-Server verloren.";
                    errorData.is_socket_connected_to_server = false; updateUI(errorData); return;
                }
                const data = await response.json(); updateUI(data);
            } catch (error) { 
                console.error('Netzwerkfehler /status:', error);
                const errorData = JSON.parse(JSON.stringify(currentPlayerData || {}));
                if (!errorData.game_state) errorData.game_state = {};
                errorData.game_state.status_display = "Netzwerkfehler zum Client-Server.";
                errorData.error_message = "Lokaler Client-Server antwortet nicht.";
                errorData.is_socket_connected_to_server = false; updateUI(errorData);
            }
        }
        fetchStatusAndUpdateUI();
        setInterval(fetchStatusAndUpdateUI, 2500); 
    </script>
</body>
</html>